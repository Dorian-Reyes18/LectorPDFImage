{% extends "base.html" %} {% block content %}
<div class="container">
  <h1>Dashboard</h1>
  <div class="row">
    <div class="col-md-8">
      <!-- Preview inicial del PDF con las primeras páginas -->
      <div id="pdf-preview-container">
        {% for page_number in range(1, min(num_pages, 5) + 1) %}
        <embed
          src="{{ url_for('pdf_page', pdf_path=pdf_path, page_number=page_number) }}"
          type="application/pdf"
          class="pdf-page"
        />
        {% endfor %}
      </div>
      <!-- Indicador de carga de páginas adicionales -->
      <div id="loading-indicator" style="display: none">
        Cargando más páginas...
      </div>
    </div>
    <div class="col-md-4">
      <!-- Barra de búsqueda -->
      <form action="{{ url_for('search') }}" method="post">
        <input
          type="text"
          id="search-input"
          name="query"
          class="form-control mb-3"
          placeholder="Buscar por palabra"
        />
        <input
          type="hidden"
          id="pdf-path-input"
          name="pdf_path"
          value="{{ pdf_path }}"
        />
        <button type="submit" class="btn btn-primary mb-3">Buscar</button>
      </form>
      <!-- Información del PDF -->
      <h4>Información del PDF:</h4>
      <p><strong>Cantidad de páginas:</strong> {{ num_pages }}</p>
    </div>
  </div>
</div>

<script>
  // Función para cargar más páginas del PDF cuando el usuario se desplaza hacia abajo
  function loadMorePages() {
    const container = document.getElementById("pdf-preview-container");
    const loadingIndicator = document.getElementById("loading-indicator");
    const lastPage = container.querySelector(".pdf-page:last-child");
    const lastPageNumber = parseInt(lastPage.getAttribute("data-page-number"));

    if (lastPageNumber < {{ num_pages }}) {
      const nextPageNumber = lastPageNumber + 1;
      const nextPage = document.createElement("embed");
      nextPage.src = `{{ url_for('pdf_page', pdf_path=pdf_path, page_number='__page_number__') }}`.replace("__page_number__", nextPageNumber);
      nextPage.type = "application/pdf";
      nextPage.classList.add("pdf-page");
      nextPage.setAttribute("data-page-number", nextPageNumber);
      container.appendChild(nextPage);
      loadingIndicator.style.display = "none";
    }
  }

  // Detectar el evento de desplazamiento del usuario y cargar más páginas cuando sea necesario
  window.addEventListener("scroll", () => {
    const container = document.getElementById("pdf-preview-container");
    const loadingIndicator = document.getElementById("loading-indicator");
    const lastPage = container.querySelector(".pdf-page:last-child");
    const lastPageOffset = lastPage.getBoundingClientRect().bottom;

    if (lastPageOffset <= window.innerHeight) {
      loadingIndicator.style.display = "block";
      loadMorePages();
    }
  });

  // Cargar más páginas cuando la página se cargue por primera vez si es necesario
  document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById("pdf-preview-container");
    const numPages = {{ num_pages }};

    if (container.offsetHeight <= window.innerHeight && numPages > 5) {
      loadMorePages();
    }
  });
</script>
{% endblock %}
